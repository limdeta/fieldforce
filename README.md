# Instock FieldForce

Приложение для торговых представителей компании.

Любые взаимодействия с внешними сервисами производить в виде заглушек/моков, максимально приближённых к реальному API.

Roadmap:
Нужно сделать MVP в виде магазина с offline-first каталогом. Отработать импорты и интерфейсы.
  - **Торговые точки**. Проверить, есть ли связь «точки - пользователь». Сейчас стоит заглушка, которая при первом входе импортирует и устанавливает точку из текущей выбранной на Instock. Нужно сделать способ обновления точек для пользователя. Пока можно сделать в виде заглушки: захардкодить response в виде нескольких реальных точек из Instock (Камчатка, Магадан, Владивосток). Обновить страницу с ТТ и сделать выбор точки (пока вручную выбираем точку).

  - **Каталог. Отображение.** Сделать настройку отображения (обычный режим: каталог и товары — разные страницы; и split-режим, когда каталог и товары на одном экране). Настройку можно хранить в user preferences, которые уже готовы к использованию. Кешировать расчёт количества товаров в дереве.

  - **Каталог. Категории прайса.** Сделать всё то же самое, что с обычными категориями.
  
  - **Каталог. Характеристики, фильтры и поиск.** Реализовать базовый поиск по товарам в офлайн-режиме. Реализовать фесетный поиск(не очевидно как аггрегировать все возможные характеристики и аттрибуты, на инстоке этим всем занимается elastic). В онлайн-режиме делать запрос на бэкенд и отрисовывать результаты в каталоге. Подумать, как можно делать пагинацию при работе с бэкендом и как кешировать картинки/информацию.

  - **Импорт продуктов.** Определить, как оптимальнее всего хранить товары (конкретный stock-item с ценой) отдельно от продуктов. Цены и остатки напрямую зависят от выбранной торговой точки. Пример таблицы :
```
PRODUCT | WAREHOUSE | STOCK | PRICE | DISCOUNT | TP
___________________________________________________
1       | основной  | 2     | 12    | 5        | 69
1       | уценка    | 10    | 5     | 0        | 69
1       | основной  | 2     | 12    | 5        | 77
1       | уценка    | 10    | 12    | 0        | 77
1       | камчатка  | 0     | 0     | 0        | 2
1       | магадан   | 2     | 12    | 5        | 3
```
   Придумать структуру и алгоритм хранения. Нет смысла для каждой точки делать уникальную запись. Склад + Цена + Остаток всегда уникальны; если у нас нет скидки или любого другого модификатора для ТТ, то нам достаточно этой записи. Если для ТТ есть уникальная цена - нужно хранить её отдельно. Возможно, стоит нормализовать эту таблицу на несколько.

   - **Импорт.** Нужно максимально быстро и эффективно передавать большие объёмы данных: бинарные форматы, архивы, параллельная отправка чанками, protobuf и т. п. У нас должно быть два способа обновить любую сущность: массовая (полная) синхронизация и обычный request-response, возвращающий JSON, используя по максимуму уже существующие API. В текущий момент частично реализован второй вариант, но он выполняет задачу первого; должен быть максимально атомарным.

   - **Заказ.** Ставить заказы в очередь, проверить и доделать конечный автомат. Создать механизм отправки. Когда есть интернет - пытаемся провести заказ на сайте (3 попытки с увеличением задержки). Если интернета нет - ничего не делаем, ждём стабильного интернета (изучить, как приложение поймёт, что интернет появился и достаточно стабилен). Отображать список заказов и их состояния в панели Заказы.

   - **Корзина.** Скопировать с сайта, кроме способа получения.

   - **Акции.** Продумать акции и как их хранить, а также привязку к точкам и товарам.

   - **Интерфейс.** Привести всё к единому стилю. Использовать цвета темы а не хардкодить.

   - **todo**

Команды:
```bash
flutter pub run build_runner build --delete-conflicting-outputs
flutter test
```

Пример интеграционного теста:
```bash
flutter test .\integration_test\login_test.dart -d windows --dart-define=ENV=dev
```

Для разработки (dev режим по умолчанию с фикстурами):
```bash
flutter run -d windows --dart-define=flutter.flutter_map.unblockOSM="Our tile servers are not." --dart-define=ENV=dev
```

Собрать APK:
```bash
flutter build apk --dart-define=ENV=prod --release --dart-define=flutter.flutter_map.unblockOSM="Our tile servers are not."
```