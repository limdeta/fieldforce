# üöÄ Protobuf Sync Module

–ú–æ–¥—É–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Protocol Buffers –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è FieldForce.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ú–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:

### 1. –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
- **RegionalSyncService** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞
- Endpoint: `/v1_api/mobile-sync/regional/{regionFiasId}`
- –ß–∞—Å—Ç–æ—Ç–∞: —Ä–∞–∑ –≤ –¥–µ–Ω—å –∏–ª–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–≥–∏–æ–Ω–∞
- –û–±—ä–µ–º: –ø–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –±–∞–∑–æ–≤—ã–º–∏ —Ü–µ–Ω–∞–º–∏

### 2. –£—Ä–æ–≤–µ–Ω—å —Ç–æ—á–µ–∫ (–µ–∂–µ—á–∞—Å–Ω–æ)  
- **StockSyncService** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö
- **OutletPricingSyncService** - –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫
- Endpoints: 
  - `/v1_api/mobile-sync/regional-stock/{regionFiasId}`
  - `/v1_api/mobile-sync/outlet-pricing/{outletId}`
- –ß–∞—Å—Ç–æ—Ç–∞: –∫–∞–∂–¥—ã–µ 15-60 –º–∏–Ω—É—Ç
- –û–±—ä–µ–º: —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ —Ü–µ–Ω

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
lib/features/shop/data/sync/
‚îú‚îÄ‚îÄ proto/                    # .proto —Ñ–∞–π–ª—ã (–∫–æ–ø–∏–∏ —Å –±—ç–∫–µ–Ω–¥–∞)
‚îÇ   ‚îú‚îÄ‚îÄ product.proto
‚îÇ   ‚îú‚îÄ‚îÄ stockitem.proto
‚îÇ   ‚îî‚îÄ‚îÄ sync.proto
‚îú‚îÄ‚îÄ generated/               # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ Dart –∫–ª–∞—Å—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ product.pb.dart
‚îÇ   ‚îú‚îÄ‚îÄ stockitem.pb.dart
‚îÇ   ‚îî‚îÄ‚îÄ sync.pb.dart
‚îú‚îÄ‚îÄ services/               # –°–µ—Ä–≤–∏—Å—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ regional_sync_service.dart
‚îÇ   ‚îú‚îÄ‚îÄ stock_sync_service.dart
‚îÇ   ‚îú‚îÄ‚îÄ outlet_pricing_sync_service.dart
‚îÇ   ‚îî‚îÄ‚îÄ protobuf_sync_coordinator.dart
‚îú‚îÄ‚îÄ models/                # DTO –∏ –∫–æ–Ω–≤–µ—Ä—Ç–æ—Ä—ã
‚îú‚îÄ‚îÄ repositories/         # –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
‚îî‚îÄ‚îÄ README.md           # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ

```dart
// –í service_locator.dart
void _registerSyncServices() {
  final baseUrl = AppConfig.apiBaseUrl;
  
  GetIt.instance.registerLazySingleton(() => RegionalSyncService(
    baseUrl: baseUrl,
  ));
  
  GetIt.instance.registerLazySingleton(() => StockSyncService(
    baseUrl: baseUrl,
  ));
  
  GetIt.instance.registerLazySingleton(() => OutletPricingSyncService(
    baseUrl: baseUrl,
  ));
  
  GetIt.instance.registerLazySingleton(() => ProtobufSyncCoordinator(
    regionalSyncService: GetIt.instance<RegionalSyncService>(),
    stockSyncService: GetIt.instance<StockSyncService>(),
    outletPricingSyncService: GetIt.instance<OutletPricingSyncService>(),
  ));
}
```

### –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–µ–≥–∏–æ–Ω–∞

```dart
final coordinator = GetIt.instance<ProtobufSyncCoordinator>();

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏–æ–Ω–Ω—É—é –∫—É–∫—É –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
coordinator.setSessionCookie('PHPSESSID=abc123...');

// –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
final result = await coordinator.performFullRegionalSync(
  'c2deb16a-0330-4f05-821f-1d09c93331e6', // FIAS –∫–æ–¥ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞
  [123, 456, 789], // ID —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫
  forceFullSync: true,
);

print('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${result}');
```

### –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

```dart
// –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
final result = await coordinator.performIncrementalSync(
  'c2deb16a-0330-4f05-821f-1d09c93331e6',
  [123, 456], // –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ—á–∫–∏
);
```

## üåê Endpoints API

### Regional Cache
```
POST /v1_api/mobile-sync/regional/{regionFiasId}
Content-Type: application/x-protobuf
Accept-Encoding: gzip

Request: RegionalCacheRequest
Response: RegionalCacheResponse (gzip-compressed)
```

### Regional Stock  
```
POST /v1_api/mobile-sync/regional-stock/{regionFiasId}
Content-Type: application/x-protobuf

Request: RegionalCacheRequest (—Å lastSyncTimestamp)
Response: RegionalCacheResponse (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏–≤—à–∏–µ—Å—è –æ—Å—Ç–∞—Ç–∫–∏)
```

### Outlet Pricing
```
POST /v1_api/mobile-sync/outlet-pricing/{outletId}  
Content-Type: application/x-protobuf

Request: OutletSpecificRequest
Response: OutletSpecificResponse (—Ü–µ–Ω—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—á–∫–∏)
```

## ‚ö° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ protobuf

1. **–ö–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—å**: ~60% –º–µ–Ω—å—à–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å JSON
2. **–°–∫–æ—Ä–æ—Å—Ç—å**: –±—ã—Å—Ç—Ä–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
3. **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: —Å—Ç—Ä–æ–≥–∏–µ —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö
4. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: —ç–≤–æ–ª—é—Ü–∏—è —Å—Ö–µ–º –±–µ–∑ breaking changes
5. **Gzip-—Å–∂–∞—Ç–∏–µ**: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–∞–∫–µ—Ç `logging` —Å —ç–º–æ–¥–∑–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞:

- üîÑ –ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤  
- üí∞ –†–∞–±–æ—Ç–∞ —Å —Ü–µ–Ω–∞–º–∏
- ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- ‚ùå –û—à–∏–±–∫–∏
- üç™ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

## üìã TODO

- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–æ—Ä—ã protobuf -> domain entities
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î —á–µ—Ä–µ–∑ repositories
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –°–æ–∑–¥–∞—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è network failures
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å queue-based —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–∞

## üÜö –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å JSON API

| –ü–∞—Ä–∞–º–µ—Ç—Ä | JSON API | Protobuf API |
|----------|----------|--------------|
| –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö | 100% | ~40% |
| –°–∫–æ—Ä–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞ | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è |
| –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | –°–ª–∞–±–∞—è | –°—Ç—Ä–æ–≥–∞—è |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ö–µ–º | –ù–µ—Ç | –î–∞ |
| Gzip-—Å–∂–∞—Ç–∏–µ | –î–∞ | –î–∞ |
| –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ—Å—Ç—å | –î–∞ | –ù–µ—Ç |
| IDE –ø–æ–¥–¥–µ—Ä–∂–∫–∞ | –°–ª–∞–±–∞—è | –°–∏–ª—å–Ω–∞—è |

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: Protobuf API —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –≥–¥–µ –≤–∞–∂–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —ç–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞.

## üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ protoc (Windows —Å Chocolatey)
choco install protoc

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Dart –ø–ª–∞–≥–∏–Ω–∞
flutter pub global activate protoc_plugin

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Dart –∫–ª–∞—Å—Å–æ–≤
protoc --dart_out=generated proto/*.proto
```

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏**: –ü–æ–¥–∫–ª—é—á–∏—Ç—å protobuf sync –∫ —Ç–µ–∫—É—â–∏–º BLoC –∏ use cases
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**: –°—Ä–∞–≤–Ω–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö —Å JSON API  
3. **–û—Ñ–ª–∞–π–Ω –ø–æ–¥–¥–µ—Ä–∂–∫–∞**: –î–æ–±–∞–≤–∏—Ç—å queue-based —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ —Å–µ—Ç–∏
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –æ–±—â—É—é —Å–∏—Å—Ç–µ–º—É —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏