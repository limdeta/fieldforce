# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å API —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üì± –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Dart/Flutter

### –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

API –º–æ–±–∏–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è** –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–∞–±–æ—Ç—ã —Ç–æ—Ä–≥–æ–≤—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–µ–π:

1. **üåç –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å —É—Ç—Ä–æ–º):
   - –ü—Ä–æ–¥—É–∫—Ç—ã —Ä–µ–≥–∏–æ–Ω–∞ (~7000+ —Ç–æ–≤–∞—Ä–æ–≤)
   - –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö —Ä–µ–≥–∏–æ–Ω–∞ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –ø—Ä–æ–¥—É–∫—Ç–∞–º
   - –ë–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã —Ä–µ–≥–∏–æ–Ω–∞

2. **üè™ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫** (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–π —á–∞—Å):
   - –¢–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ (~110 –∑–∞–ø–∏—Å–µ–π)
   - –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–∞–∑–Ω–∏—Ü–∞ —Å —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏)

**üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ:**
- **–¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤** (—Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è, ~7000 –∑–∞–ø–∏—Å–µ–π)
- **–¢–∞–±–ª–∏—Ü–∞ —Å–∫–ª–∞–¥–æ–≤ –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤** (—Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è, —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –ø—Ä–æ–¥—É–∫—Ç–∞–º)
- **–¢–∞–±–ª–∏—Ü–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω** (StockItem + –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ + –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞)

**üöÄ –ö–ª—é—á–µ–≤–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** 
- –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å (—É—Ç—Ä–æ–º)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤: –∫–∞–∂–¥—ã–π —á–∞—Å (~10-50 –ú–ë)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –¥–ª—è —Ç–æ—á–∫–∏: –∫–∞–∂–¥—ã–π —á–∞—Å (~100-500 –ö–ë)

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–î–æ–±–∞–≤—å—Ç–µ –≤ `pubspec.yaml`:

```yaml
dependencies:
  http: ^1.1.0
  protobuf: ^3.1.0
  sqflite: ^2.3.0  # –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
```

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Dart-–∫–ª–∞—Å—Å–æ–≤ –∏–∑ proto-—Å—Ö–µ–º

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ proto-—Ñ–∞–π–ª—ã –∏–∑ –±—ç–∫–µ–Ω–¥–∞:
- `backend/src/MobileSync/Proto/product.proto`
- `backend/src/MobileSync/Proto/stockitem.proto`
- `backend/src/MobileSync/Proto/sync.proto`

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ Dart-–∫–ª–∞—Å—Å—ã:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ protoc –∏ –ø–ª–∞–≥–∏–Ω –¥–ª—è Dart
dart pub global activate protoc_plugin

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞—Å—Å–æ–≤
protoc --dart_out=lib/generated \
    -I=proto \
    proto/product.proto \
    proto/stockitem.proto \
    proto/sync.proto
```

### 3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```dart
import 'dart:io';
import 'package:http/http.dart' as http;
import 'generated/sync.pb.dart';

class MobileSyncService {
  final String baseUrl;
  
  MobileSyncService(this.baseUrl);
  
  /// üåç –ü–û–õ–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (—É—Ç—Ä–æ–º, 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å)
  Future<void> performFullSync(String regionFiasId, List<String> outletVendorIds) async {
    print('üåÖ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é —É—Ç—Ä–µ–Ω–Ω—é—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...');
    
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø—Ä–æ–¥—É–∫—Ç—ã + –±–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã)
    final regionalData = await getRegionalData(regionFiasId);
    await saveRegionalData(regionalData);
    
    // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö
    final stockData = await getRegionalStock(regionFiasId);
    await saveStockData(stockData);
    
    // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    for (final outletId in outletVendorIds) {
      final outletPrices = await getOutletPrices(outletId);
      await saveOutletPrices(outletId, outletPrices);
    }
    
    print('‚úÖ –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  }
  
  /// ‚è∞ –ß–ê–°–û–í–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï (–æ—Å—Ç–∞—Ç–∫–∏ + —Ü–µ–Ω—ã)
  Future<void> performHourlySync(String regionFiasId, List<String> outletVendorIds) async {
    print('‚è∞ –ß–∞—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ —Ü–µ–Ω...');
    
    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö
    final stockData = await getRegionalStock(regionFiasId);
    await updateStockData(stockData);
    
    // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫
    for (final outletId in outletVendorIds) {
      final outletPrices = await getOutletPrices(outletId);
      await updateOutletPrices(outletId, outletPrices);
    }
    
    print('‚úÖ –ß–∞—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
  }
  
  /// üåç –≠–¢–ê–ü 1: –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)
  Future<RegionalCacheResponse> getRegionalData(String regionFiasId) async {
    final url = Uri.parse('$baseUrl/v1_api/mobile-sync/regional/$regionFiasId');
    
    final response = await http.get(url, headers: {
      'Accept': 'application/x-protobuf',
    });
    
    if (response.statusCode == 200) {
      final decompressedBytes = gzip.decode(response.bodyBytes);
      final regionalData = RegionalCacheResponse.fromBuffer(decompressedBytes);
      
      print('‚úÖ –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${regionalData.products.length} —Ç–æ–≤–∞—Ä–æ–≤');
      return regionalData;
    }
    
    throw Exception('HTTP ${response.statusCode}: ${response.body}');
  }
  
  /// üè™ –≠–¢–ê–ü 2: –ü–æ–ª—É—á–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
  Future<OutletSpecificCacheResponse> getOutletPrices(String outletVendorId) async {
    final url = Uri.parse('$baseUrl/v1_api/mobile-sync/outlet-prices/$outletVendorId');
    
    final response = await http.get(url, headers: {
      'Accept': 'application/x-protobuf',
    });
    
    if (response.statusCode == 200) {
      final decompressedBytes = gzip.decode(response.bodyBytes);
      final outletPrices = OutletSpecificCacheResponse.fromBuffer(decompressedBytes);
      
      print('‚úÖ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã: ${outletPrices.differentialProducts.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω');
      print('üìä –≠–∫–æ–Ω–æ–º–∏—è: ${7000 - outletPrices.differentialProducts.length} —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ');
      
      return outletPrices;
    }
    
    throw Exception('HTTP ${response.statusCode}: ${response.body}');
  }
  
  /// üì¶ –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏
  Future<RegionalStockResponse> getRegionalStock(String regionFiasId) async {
    final url = Uri.parse('$baseUrl/v1_api/mobile-sync/regional-stock/$regionFiasId');
    
    final response = await http.get(url, headers: {
      'Accept': 'application/x-protobuf',
    });
    
    if (response.statusCode == 200) {
      final decompressedBytes = gzip.decode(response.bodyBytes);
      final stockData = RegionalStockResponse.fromBuffer(decompressedBytes);
      
      print('‚úÖ –û—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${stockData.stockItems.length} –ø–æ–∑–∏—Ü–∏–π');
      return stockData;
    }
    
    throw Exception('HTTP ${response.statusCode}: ${response.body}');
  }
  
  /// üíæ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω
  Map<int, ProductWithPrice> mergeRegionalAndOutletData(
    RegionalCacheResponse regional,
    OutletSpecificCacheResponse outlet,
  ) {
    final result = <int, ProductWithPrice>{};
    
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Å –±–∞–∑–æ–≤—ã–º–∏ —Ü–µ–Ω–∞–º–∏
    for (final product in regional.products) {
      result[product.code] = ProductWithPrice(
        product: product,
        finalPrice: product.regionalPrice, // –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —Ä–µ–≥–∏–æ–Ω–∞
        priceType: 'regional_base',
      );
    }
    
    // 2. –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏ –¥–ª—è —Ç–æ—á–∫–∏
    for (final diffProduct in outlet.differentialProducts) {
      if (result.containsKey(diffProduct.productCode)) {
        result[diffProduct.productCode] = ProductWithPrice(
          product: result[diffProduct.productCode]!.product,
          finalPrice: diffProduct.outletSpecificPrice, // –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ —Ç–æ—á–∫–∏
          priceType: diffProduct.type,
          regionalBasePrice: diffProduct.regionalBasePrice,
          priceDifference: diffProduct.priceDifference,
          priceDifferencePercent: diffProduct.priceDifferencePercent,
          hasPromotion: diffProduct.hasPromotion(),
        );
      }
    }
    
    return result;
  }
}

/// –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞ —Å –∏—Ç–æ–≥–æ–≤–æ–π —Ü–µ–Ω–æ–π
class ProductWithPrice {
  final Product product;
  final int finalPrice;         // –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  final String priceType;       // "regional_base", "differential_price", "promotion"
  final int? regionalBasePrice; // –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —Ä–µ–≥–∏–æ–Ω–∞ (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
  final int? priceDifference;   // —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  final double? priceDifferencePercent;
  final bool hasPromotion;
  
  ProductWithPrice({
    required this.product,
    required this.finalPrice,
    required this.priceType,
    this.regionalBasePrice,
    this.priceDifference,
    this.priceDifferencePercent,
    this.hasPromotion = false,
  });
  
  /// –ï—Å—Ç—å –ª–∏ —Å–∫–∏–¥–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã
  bool get hasDiscount => priceDifference != null && priceDifference! < 0;
  
  /// –ï—Å—Ç—å –ª–∏ –Ω–∞—Ü–µ–Ω–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã
  bool get hasMarkup => priceDifference != null && priceDifference! > 0;
}
```

### 4. –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```dart
void main() async {
  final syncService = MobileSyncService('https://your-backend.com');
  
  const regionFiasId = '43909681-d6e1-432d-b61f-ddac393cb5da'; // –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫
  const outletVendorId = 'OUTLET_12345';
  
  try {
    // üåç –®–∞–≥ 1: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (7000+ —Ç–æ–≤–∞—Ä–æ–≤)
    final regionalData = await syncService.getRegionalData(regionFiasId);
    
    // üè™ –®–∞–≥ 2: –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã —Ç–æ—á–∫–∏ (~110 —Ç–æ–≤–∞—Ä–æ–≤)
    final outletPrices = await syncService.getOutletPrices(outletVendorId);
    
    // üíæ –®–∞–≥ 3: –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
    final finalProducts = syncService.mergeRegionalAndOutletData(regionalData, outletPrices);
    
    print('‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ: ${finalProducts.length} —Ç–æ–≤–∞—Ä–æ–≤');
    print('üìä –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω: ${outletPrices.differentialProducts.length}');
    print('üéØ –ë–∞–∑–æ–≤—ã—Ö —Ü–µ–Ω: ${regionalData.products.length - outletPrices.differentialProducts.length}');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
    await saveToLocalDatabase(finalProducts);
    
  } catch (e) {
    print('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: $e');
  }
}
```

---

## üåç –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ FIAS ID

| –†–µ–≥–∏–æ–Ω       | FIAS ID                              |
|--------------|--------------------------------------|
| –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫  | `43909681-d6e1-432d-b61f-ddac393cb5da` |
| –ú–∞–≥–∞–¥–∞–Ω      | `9c05e812-8679-4710-b8cb-5e8bd43cdf48` |
| –ö–∞–º—á–∞—Ç–∫–∞     | `d02f30fc-83bf-4c0f-ac2b-5729a866a207` |

---

## üìã API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### GET /v1_api/mobile-sync/regional/{regionFiasId}
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (—É—Ç—Ä–æ–º)
- –ü—Ä–æ–¥—É–∫—Ç—ã —Ä–µ–≥–∏–æ–Ω–∞
- –ë–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã —Ä–µ–≥–∏–æ–Ω–∞
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–ª–∞–¥–∞—Ö

**–†–∞–∑–º–µ—Ä:** ~15-25 –ú–ë (—Å–∂–∞—Ç–æ)
**–ß–∞—Å—Ç–æ—Ç–∞:** 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å

### GET /v1_api/mobile-sync/regional-stock/{regionFiasId}
**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö (–∫–∞–∂–¥—ã–π —á–∞—Å)
- –¢–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –±–µ–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –ø—Ä–æ–¥—É–∫—Ç–∞–º

**–†–∞–∑–º–µ—Ä:** ~5-15 –ú–ë (—Å–∂–∞—Ç–æ)
**–ß–∞—Å—Ç–æ—Ç–∞:** –∫–∞–∂–¥—ã–π —á–∞—Å

### GET /v1_api/mobile-sync/outlet-prices/{outletVendorId}
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
- –¢–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã —Å —Ü–µ–Ω–∞–º–∏, –æ—Ç–ª–∏—á–∞—é—â–∏–º–∏—Å—è –æ—Ç —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö
- –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–†–∞–∑–º–µ—Ä:** ~100-500 –ö–ë (—Å–∂–∞—Ç–æ)
**–ß–∞—Å—Ç–æ—Ç–∞:** –∫–∞–∂–¥—ã–π —á–∞—Å

---

## üóÇÔ∏è –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### RegionalCacheResponse (–ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Ç—Ä–æ–º)

```protobuf
message RegionalCacheResponse {
    repeated Product products = 1;              // –í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Ä–µ–≥–∏–æ–Ω–∞
    repeated Warehouse warehouses = 2;          // –°–∫–ª–∞–¥—ã —Ä–µ–≥–∏–æ–Ω–∞
    int64 sync_timestamp = 3;
    string cache_type = 4;                     // "regional_full"
    CacheStats stats = 5;
}
```

### RegionalStockResponse (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∫–∞–∂–¥—ã–π —á–∞—Å)

```protobuf
message RegionalStockResponse {
    RegionInfo region_info = 1;                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–≥–∏–æ–Ω–µ
    repeated StockItem stock_items = 2;        // –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö
    int64 sync_timestamp = 3;
    string cache_type = 4;                     // "regional_stock_update"
    CacheStats stats = 5;
}
```

### StockItem (–æ—Å—Ç–∞—Ç–∫–∏ —Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏)

```protobuf
message StockItem {
    int32 product_code = 1;                    // –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç
    int32 warehouse_id = 2;                    // ID —Å–∫–ª–∞–¥–∞
    int32 quantity = 3;                        // –û—Å—Ç–∞—Ç–æ–∫
    int32 reserved_quantity = 4;               // –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ
    int32 available_quantity = 5;              // –î–æ—Å—Ç—É–ø–Ω–æ –∫ –ø—Ä–æ–¥–∞–∂–µ
    int64 last_updated = 6;                    // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    
    // –¶–µ–Ω—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –±—ç–∫–µ–Ω–¥–µ)
    repeated OutletPrice outlet_prices = 7;    // –¶–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
}
```

### OutletPrice (—Ü–µ–Ω–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏)

```protobuf
message OutletPrice {
    string outlet_vendor_id = 1;               // ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
    int32 final_price = 2;                     // –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
    int32 regional_base_price = 3;             // –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —Ä–µ–≥–∏–æ–Ω–∞
    int32 price_difference = 4;                // –†–∞–∑–Ω–∏—Ü–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    float price_difference_percent = 5;         // –†–∞–∑–Ω–∏—Ü–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
    string price_type = 6;                     // "regional_base", "differential", "promotion"
    bool has_promotion = 7;                    // –ï—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –∞–∫—Ü–∏—è
}
```

---

## üíæ –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø —Å—Ö–µ–º–∞ SQLite (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)

### –ß–µ—Ç—ã—Ä–µ—Ö—Ç–∞–±–ª–∏—á–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

```sql
-- 1. –ü—Ä–æ–¥—É–∫—Ç—ã (—Å—Ç–∞—Ç–∏—á–Ω—ã–µ, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å)
CREATE TABLE products (
    code INTEGER PRIMARY KEY,
    bcode INTEGER,
    title TEXT NOT NULL,
    vendor_code TEXT,
    brand_name TEXT,
    manufacturer_name TEXT,
    category_name TEXT,
    -- –ù–ï–¢ —Ü–µ–Ω! –¢–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
    sync_timestamp INTEGER,
    region_fias_id TEXT
);

-- 2. –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å, –ë–ï–ó –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω)
CREATE TABLE regional_stock_items (
    id INTEGER PRIMARY KEY,
    product_code INTEGER NOT NULL,
    warehouse_id INTEGER NOT NULL,
    warehouse_name TEXT,
    public_stock TEXT,                    -- "1666 —à—Ç."
    multiplicity INTEGER DEFAULT 1,
    regional_base_price INTEGER,          -- –¢–û–õ–¨–ö–û –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —Ä–µ–≥–∏–æ–Ω–∞
    last_updated INTEGER,
    region_fias_id TEXT,
    FOREIGN KEY (product_code) REFERENCES products(code),
    UNIQUE(product_code, warehouse_id)
);

-- 3. –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å)
CREATE TABLE outlet_stock_pricing (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    stock_item_id INTEGER NOT NULL,         -- —Å—Å—ã–ª–∫–∞ –Ω–∞ regional_stock_items
    product_code INTEGER NOT NULL,          -- –¥—É–±–ª—å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    warehouse_id INTEGER NOT NULL,          -- –¥—É–±–ª—å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    outlet_vendor_id TEXT NOT NULL,         -- ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
    
    -- –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è —ç—Ç–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
    final_price INTEGER NOT NULL,           -- –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞
    price_difference INTEGER DEFAULT 0,     -- —Ä–∞–∑–Ω–∏—Ü–∞ —Å –±–∞–∑–æ–≤–æ–π
    price_difference_percent REAL DEFAULT 0,
    price_type TEXT DEFAULT 'regional_base',
    
    -- –°–∫–∏–¥–∫–∏ –∏ –∞–∫—Ü–∏–∏
    discount_value REAL DEFAULT 0,
    has_promotion BOOLEAN DEFAULT FALSE,
    promotion_id INTEGER,                   -- —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É –∞–∫—Ü–∏–π
    
    last_updated INTEGER,
    FOREIGN KEY (stock_item_id) REFERENCES regional_stock_items(id),
    FOREIGN KEY (product_code) REFERENCES products(code),
    UNIQUE(stock_item_id, outlet_vendor_id)
);

-- 4. –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏ (–æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏)
CREATE TABLE active_promotions (
    id INTEGER PRIMARY KEY,
    outlet_vendor_id TEXT NOT NULL,
    promotion_type TEXT,                   -- "discount", "nx", "bundle"
    title TEXT,
    description TEXT,
    valid_from INTEGER,
    valid_to INTEGER,
    discount_percent REAL,
    discount_amount INTEGER,
    -- –î–µ—Ç–∞–ª–∏ NX –∞–∫—Ü–∏–π
    buy_quantity INTEGER,
    get_quantity INTEGER,
    -- –£—Å–ª–æ–≤–∏—è
    min_quantity INTEGER,
    max_quantity INTEGER,
    min_amount INTEGER
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_stock_items_product ON regional_stock_items(product_code);
CREATE INDEX idx_stock_items_warehouse ON regional_stock_items(warehouse_id);
CREATE INDEX idx_stock_items_region ON regional_stock_items(region_fias_id);

CREATE INDEX idx_outlet_pricing_outlet ON outlet_stock_pricing(outlet_vendor_id);
CREATE INDEX idx_outlet_pricing_product_outlet ON outlet_stock_pricing(product_code, outlet_vendor_id);
CREATE INDEX idx_outlet_pricing_warehouse_outlet ON outlet_stock_pricing(warehouse_id, outlet_vendor_id);
CREATE INDEX idx_outlet_pricing_stock_item ON outlet_stock_pricing(stock_item_id);

CREATE INDEX idx_promotions_outlet ON active_promotions(outlet_vendor_id);
CREATE INDEX idx_promotions_dates ON active_promotions(valid_from, valid_to);
```

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã:

#### üî• –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞
```dart
// –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä —Å —Ü–µ–Ω–æ–π –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ (1 –∑–∞–ø—Ä–æ—Å!)
Future<ProductWithPrice> getProductForOutlet(int productCode, String outletVendorId) async {
  final result = await db.rawQuery('''
    SELECT 
      p.code, p.title, p.vendor_code, p.brand_name,
      rsi.warehouse_id, rsi.warehouse_name, rsi.public_stock,
      rsi.regional_base_price,
      COALESCE(osp.final_price, rsi.regional_base_price) as final_price,
      COALESCE(osp.price_type, 'regional_base') as price_type,
      COALESCE(osp.has_promotion, 0) as has_promotion,
      ap.title as promotion_title
    FROM products p
    JOIN regional_stock_items rsi ON p.code = rsi.product_code
    LEFT JOIN outlet_stock_pricing osp ON rsi.id = osp.stock_item_id AND osp.outlet_vendor_id = ?
    LEFT JOIN active_promotions ap ON osp.promotion_id = ap.id
    WHERE p.code = ?
  ''', [outletVendorId, productCode]);
  
  return ProductWithPrice.fromMap(result.first);
}
```

#### üéØ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö
```dart
class OptimizedSyncService {
  /// –≠–¢–ê–ü 1: –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Ç—Ä–æ–º
  Future<void> performMorningSync(String regionFiasId, List<String> outletIds) async {
    // 1. –ü—Ä–æ–¥—É–∫—Ç—ã (–æ–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å)
    final products = await getRegionalProducts(regionFiasId);
    await saveProducts(products);
    
    // 2. –û—Å—Ç–∞—Ç–∫–∏ —Å –±–∞–∑–æ–≤—ã–º–∏ —Ü–µ–Ω–∞–º–∏ (–∫–∞–∂–¥—ã–π —á–∞—Å)
    final stockItems = await getRegionalStock(regionFiasId);
    await saveRegionalStock(stockItems);
    
    // 3. –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
    for (final outletId in outletIds) {
      final pricing = await getOutletPricing(outletId);
      await saveOutletPricing(outletId, pricing);
    }
  }
  
  /// –≠–¢–ê–ü 2: –ß–∞—Å–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–∏ + —Ü–µ–Ω—ã)
  Future<void> performHourlyUpdate(String regionFiasId, List<String> outletIds) async {
    // –û—Å—Ç–∞—Ç–∫–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å -> –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    final stockItems = await getRegionalStock(regionFiasId);
    await updateRegionalStock(stockItems);
    
    // –¶–µ–Ω—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å -> –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
    for (final outletId in outletIds) {
      final pricing = await getOutletPricing(outletId);
      await updateOutletPricing(outletId, pricing);
    }
  }
}
```

### ‚ö° –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –Ω–∞ –±—ç–∫–µ–Ω–¥–µ –∏ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

#### üñ•Ô∏è –ë–≠–ö–ï–ù–î: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–µ–¥–≤—ã—á–∏—Å–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```php
// –í RegionalStockItemService - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
public function generateRegionalStockCache(Region $region): array
{
    // –¢–æ–ª—å–∫–æ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ —Å –±–∞–∑–æ–≤—ã–º–∏ —Ü–µ–Ω–∞–º–∏ (–ë–ï–ó —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫)
    $stockItems = $this->getRegionalStockItems($region);
    
    $result = [];
    foreach ($stockItems as $stockItem) {
        $result[] = [
            'id' => $stockItem->getId(),
            'product_code' => $stockItem->getProduct()->getCode(),
            'warehouse_id' => $stockItem->getWarehouse()->getId(),
            'public_stock' => $stockItem->getPublicStock(),
            'multiplicity' => $stockItem->getMultiplicity(),
            // –¢–û–õ–¨–ö–û –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —Ä–µ–≥–∏–æ–Ω–∞
            'regional_base_price' => $this->aussPricingService->getRegionalBasePrice(
                $stockItem->getProduct(), 
                $region
            ),
        ];
    }
    
    return ['stock_items' => $result];
}

// –í OutletSpecificPricingService - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã
public function generateOutletPricing(Outlet $outlet): array
{
    $stockItems = $this->getStockItemsForOutlet($outlet);
    $region = $outlet->getRegionalUnit()->getAddress()->getRegion();
    
    $outletPricing = [];
    foreach ($stockItems as $stockItem) {
        // –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É —Ä–µ–≥–∏–æ–Ω–∞
        $regionalPrice = $this->aussPricingService->getRegionalBasePrice(
            $stockItem->getProduct(), 
            $region
        );
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è —Ç–æ—á–∫–∏
        $finalPrice = $this->aussPricingService->calculateFinalPrice(
            $outlet, 
            $stockItem->getProduct()
        );
        
        // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ–π
        if ($finalPrice !== $regionalPrice) {
            $outletPricing[] = [
                'stock_item_id' => $stockItem->getId(),
                'product_code' => $stockItem->getProduct()->getCode(),
                'warehouse_id' => $stockItem->getWarehouse()->getId(),
                'final_price' => $finalPrice,
                'price_difference' => $finalPrice - $regionalPrice,
                'price_difference_percent' => (($finalPrice - $regionalPrice) / $regionalPrice) * 100,
                'price_type' => $this->determinePriceType($outlet, $stockItem),
                'has_promotion' => $this->hasActivePromotion($outlet, $stockItem),
            ];
        }
    }
    
    return ['outlet_pricing' => $outletPricing];
}
```

#### üì± –ú–û–ë–ò–õ–¨–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï: –£–º–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ lazy loading

```dart
class MobileProductService {
  /// –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
  Future<void> performIntelligentSync(String regionFiasId, List<String> outletIds) async {
    // –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ü—Ä–æ–¥—É–∫—Ç—ã (background, –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    await _syncProducts(regionFiasId, priority: 'low');
    
    // –ü–†–ò–û–†–ò–¢–ï–¢ 2: –û—Å—Ç–∞—Ç–∫–∏ –ø–µ—Ä–≤–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    if (outletIds.isNotEmpty) {
      await _syncStockForOutlet(regionFiasId, outletIds.first, priority: 'high');
    }
    
    // –ü–†–ò–û–†–ò–¢–ï–¢ 3: –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ (background)
    for (final outletId in outletIds.skip(1)) {
      await _syncStockForOutlet(regionFiasId, outletId, priority: 'low');
    }
  }
  
  /// –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: Lazy loading —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  Future<List<ProductWithStockAndPrice>> getProductsForOutlet(
    String outletVendorId, {
    int page = 0,
    int limit = 50,
    String? searchQuery,
  }) async {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
    final cacheKey = 'products_${outletVendorId}_${page}_${searchQuery ?? "all"}';
    final cached = await _resultCache.get(cacheKey);
    if (cached != null && _isCacheValid(cached)) {
      return cached.products;
    }
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ SQLite
    final query = _buildOptimizedQuery(outletVendorId, searchQuery);
    final result = await db.rawQuery(query, [
      outletVendorId,
      limit,
      page * limit,
      if (searchQuery != null) '%$searchQuery%',
    ]);
    
    final products = result.map((row) => ProductWithStockAndPrice.fromMap(row)).toList();
    
    // –ö–µ—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 10 –º–∏–Ω—É—Ç
    await _resultCache.put(cacheKey, CachedResult(products, DateTime.now()));
    
    return products;
  }
  
  /// –°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: –ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
  Future<void> preloadPopularProducts(String outletVendorId) async {
    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ø-100 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    final popularProducts = await db.rawQuery('''
      SELECT product_code, COUNT(*) as order_count
      FROM order_history 
      WHERE outlet_vendor_id = ? 
      GROUP BY product_code 
      ORDER BY order_count DESC 
      LIMIT 100
    ''', [outletVendorId]);
    
    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç—å
    for (final product in popularProducts) {
      await getProductForOutlet(product['product_code'], outletVendorId);
    }
  }
  
  /// –°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  Future<void> performSmartUpdate(String regionFiasId, List<String> outletIds) async {
    final lastSync = await getLastSyncTimestamp();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    final changes = await checkChanges(regionFiasId, outletIds, lastSync);
    
    if (changes.hasProductChanges) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
      await updateChangedProducts(changes.changedProducts);
    }
    
    if (changes.hasStockChanges) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º —Å–∫–ª–∞–¥–∞–º
      await updateChangedStock(changes.changedWarehouses);
    }
    
    if (changes.hasPriceChanges) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫
      await updateChangedPricing(changes.changedOutlets);
    }
  }
}
```

## üéØ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

### 1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –±—ç–∫–µ–Ω–¥/–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**

**–ë–≠–ö–ï–ù–î –¥–µ–ª–∞–µ—Ç:**
- ‚úÖ –†–∞—Å—á–µ—Ç –≤—Å–µ—Ö —Ü–µ–Ω —á–µ—Ä–µ–∑ AussPricingService
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π  
- ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–∂–∞—Ç–∏–µ protobuf + gzip
- ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ñ–∞–π–ª–∞—Ö

**–ú–û–ë–ò–õ–¨–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –¥–µ–ª–∞–µ—Ç:**
- ‚úÖ –£–º–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Lazy loading —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- ‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
- ‚úÖ –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ SQLite –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

### 2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**

```dart
// –ü—Ä–∏–º–µ—Ä —ç–∫–æ–Ω–æ–º–∏–∏: –í–º–µ—Å—Ç–æ 7000 —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ü–µ–Ω–∞–º–∏ –∫–∞–∂–¥—ã–π —á–∞—Å
// –ø–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ ~110 –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ü–µ–Ω

class DataOptimization {
  /// –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: 7000 —Ç–æ–≤–∞—Ä–æ–≤ √ó 4 —Ç–æ—á–∫–∏ = 28,000 –∑–∞–ø–∏—Å–µ–π/—á–∞—Å
  /// –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: 110 –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ü–µ–Ω √ó 4 —Ç–æ—á–∫–∏ = 440 –∑–∞–ø–∏—Å–µ–π/—á–∞—Å
  /// –≠–∫–æ–Ω–æ–º–∏—è: 98.4% —Ç—Ä–∞—Ñ–∏–∫–∞!
  
  static const int PRODUCTS_COUNT = 7000;
  static const int AVERAGE_DIFFERENTIAL_PRICES = 110;
  static const int OUTLETS_COUNT = 4;
  
  static double calculateTrafficSaving() {
    final beforeOptimization = PRODUCTS_COUNT * OUTLETS_COUNT;
    final afterOptimization = AVERAGE_DIFFERENTIAL_PRICES * OUTLETS_COUNT;
    
    return ((beforeOptimization - afterOptimization) / beforeOptimization) * 100;
    // –†–µ–∑—É–ª—å—Ç–∞—Ç: 98.4% —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
  }
}
```

### 3. **–£–º–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**

```dart
class SyncStrategy {
  /// –£—Ç—Ä–µ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (06:00)
  static Future<void> morningFullSync() async {
    await performFullSync(); // –í—Å–µ –¥–∞–Ω–Ω—ã–µ
  }
  
  /// –î–Ω–µ–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–∫–∞–∂–¥—ã–π —á–∞—Å 09:00-18:00)
  static Future<void> businessHourSync() async {
    await updateStockOnly(); // –¢–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–∏
    await updatePricingOnly(); // –¢–æ–ª—å–∫–æ —Ü–µ–Ω—ã
  }
  
  /// –í–µ—á–µ—Ä–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (19:00-23:00) 
  static Future<void> eveningLightSync() async {
    await updatePricingOnly(); // –¢–æ–ª—å–∫–æ —Ü–µ–Ω—ã
  }
  
  /// –ù–æ—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (00:00-05:00)
  static Future<void> nightMaintenanceSync() async {
    await cleanupOldCache(); // –û—á–∏—Å—Ç–∫–∞
    await optimizeDatabase(); // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQLite
  }
}
```